name: Multi-Cloud CI/CD

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  setup:
    name: Setup Environment
    runs-on: ubuntu-latest

    outputs:
      cloud: ${{ steps.read_config.outputs.cloud }}

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Read cloud-config.yaml
        id: read_config
        run: |
          CLOUD=$(grep '^cloud:' config/cloud-config.yaml | awk '{print $2}')
          echo "Selected Cloud: $CLOUD"
          echo "cloud=$CLOUD" >> "$GITHUB_OUTPUT"

  deploy:
    name: Terraform + Helm Deploy
    needs: setup
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.7

      - name: Set up Kubernetes
        uses: azure/setup-kubectl@v3

      - name: Init Terraform
        run: |
          cd infra/terraform/${{ needs.setup.outputs.cloud }}
          terraform init

      - name: Apply Terraform
        run: |
          cd infra/terraform/${{ needs.setup.outputs.cloud }}
          terraform apply -auto-approve

      - name: Configure Kubeconfig
        run: |
          echo "ðŸ’¡ You should implement kubeconfig generation here based on your cloud."
          echo "Example for AWS EKS: aws eks update-kubeconfig --region us-east-1 --name <cluster-name>"
          # Add your cloud-specific kubeconfig commands here

      - name: Deploy via Helm
        run: |
          helm upgrade --install multi-cloud-app ./deployment/helm \
            --values config/cloud-config.yaml \
            --namespace default --create-namespace

      - name: Notify Success
        run: echo "âœ… Deployed successfully to ${{ needs.setup.outputs.cloud }}"
